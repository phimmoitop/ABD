name: Video to M3U8 and Deploy

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID'
        required: true
      slug:
        description: 'Slug'
        required: true
      token:
        description: 'Token'
        required: true
      projectName:
        description: 'projectName'
        required: true
      accountId:
        description: 'AccountID'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v2

      - name: Download abyss-dl.jar
        run: |
          mkdir -p tools
          curl -L \
            -o tools/abyss-dl.jar \
            https://github.com/abdlhay/AbyssVideoDownloader/releases/latest/download/abyss-dl.jar

      - name: Download video via Abyss
        run: |
          java -jar tools/abyss-dl.jar \
            -u "${{ github.event.inputs.id }}" \
            -o .

          FILE=$(ls *.mp4 | head -n 1)
          if [ ! -f "$FILE" ]; then
            echo "Không tìm thấy file mp4 sau khi tải"
            exit 1
          fi

          mv "$FILE" "${{ github.event.inputs.slug }}.mp4"

      - name: Verify video file (size + ffprobe + wait)
        run: |
          set +e
          FILE="${{ github.event.inputs.slug }}.mp4"

          for i in {1..10}; do
            if [ -f "$FILE" ]; then break; fi
            sleep 1
          done

          SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo 0)
          echo "File size: $SIZE bytes"
          if [ $SIZE -lt 1000000 ]; then
            echo "File không hợp lệ"
            exit 1
          fi

          ffprobe -v error -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 "$FILE" || exit 1
          set -e

      - name: Detect video codec
        id: codec
        run: |
          CODEC=$(ffprobe -v error -select_streams v:0 \
            -show_entries stream=codec_name \
            -of default=noprint_wrappers=1:nokey=1 \
            "${{ github.event.inputs.slug }}.mp4")

          echo "codec=$CODEC" >> $GITHUB_OUTPUT

      - name: Convert to HLS with .html segments
        run: |
          mkdir -p output
          INPUT="${{ github.event.inputs.slug }}.mp4"

          if [ "${{ steps.codec.outputs.codec }}" = "h264" ]; then
            echo "H264 → copy stream"
            ffmpeg -i "$INPUT" \
              -codec copy \
              -start_number 0 \
              -hls_time 8 \
              -hls_flags split_by_time+independent_segments \
              -start_number 10001 \
              -hls_list_size 0 \
              -hls_segment_filename "output/${{ github.event.inputs.slug }}-index%d.png" \
              -f hls "output/${{ github.event.inputs.slug }}.m3u8"
          else
            echo "AV1/khác → encode H264 + HLS"
            ffmpeg -i "$INPUT" \
              -c:v libx264 \
              -preset veryfast \
              -profile:v high \
              -level 4.2 \
              -pix_fmt yuv420p \
              -c:a aac \
              -start_number 0 \
              -hls_time 8 \
              -hls_flags split_by_time+independent_segments \
              -start_number 10001 \
              -hls_list_size 0 \
              -hls_segment_filename "output/${{ github.event.inputs.slug }}-index%d.png" \
              -f hls "output/${{ github.event.inputs.slug }}.m3u8"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.accountId }}
          projectName: ${{ github.event.inputs.projectName }}
          directory: ./output
          branch: ${{ github.event.inputs.slug }}

      - name: Callback success
        if: success()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=ok" \
            --data-urlencode "key=${{ github.event.inputs.projectName }}" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"

      - name: Callback error
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=error" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"
