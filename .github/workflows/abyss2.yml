name: Abyss 998 -> M3U8 -> Deploy -> AV1 -> Error

on:
  workflow_dispatch:
    inputs:
      id:
        description: 'ID'
        required: true
      slug:
        description: 'Slug'
        required: true
      token:
        description: 'Token'
        required: true
      projectName:
        description: 'projectName'
        required: true
      accountId:
        description: 'AccountID'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v2

      - name: Download abyss-dl.jar
        run: |
          mkdir -p tools
          curl -L -o tools/abyss-dl.jar \
            https://github.com/abdlhay/AbyssVideoDownloader/releases/latest/download/abyss-dl.jar

      - name: Download video + fix + normalize
        run: |
          RAW="${{ github.event.inputs.slug }}.raw.mp4"
          FILE="${{ github.event.inputs.slug }}.mp4"

          echo "Downloading video..."
          java -jar tools/abyss-dl.jar "${{ github.event.inputs.id }}" h -o "$RAW"

          [ -f "$RAW" ] || exit 1

          SIZE=$(stat -c%s "$RAW")
          echo "Raw size: $SIZE"
          [ "$SIZE" -gt 1000000 ] || exit 1

          echo "Trying remux (metadata fix)..."
          if ffmpeg -err_detect ignore_err -i "$RAW" -map 0 -c copy "$FILE" -y; then
            echo "Remux OK"

            CODEC=$(ffprobe -v error -select_streams v:0 \
              -show_entries stream=codec_name \
              -of default=noprint_wrappers=1:nokey=1 "$FILE")

            echo "Detected codec: $CODEC"

            if [ "$CODEC" != "h264" ]; then
              echo "Non-H264 codec → re-encode"
              rm -f "$FILE"
              NEED_ENCODE=1
            else
              NEED_ENCODE=0
            fi
          else
            echo "Remux failed → re-encode"
            NEED_ENCODE=1
          fi

          if [ "$NEED_ENCODE" = "1" ]; then
            echo "Re-encoding to H.264..."
            ffmpeg -err_detect ignore_err \
              -fflags +genpts \
              -i "$RAW" \
              -map 0:v:0 \
              -map 0:a? \
              -c:v libx264 -crf 23 -preset medium \
              -pix_fmt yuv420p \
              -r 24 -g 120 -keyint_min 120 -sc_threshold 0 \
              -c:a aac -b:a 128k \
              -movflags +faststart \
              "$FILE"
          fi

          rm -f "$RAW"

          ffprobe -v error -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 "$FILE"

      - name: Convert to HLS (.m3u8 fMP4)
        run: |
          mkdir -p output
          INPUT="${{ github.event.inputs.slug }}.mp4"

          ffmpeg -i "$INPUT" \
            -map 0:v:0 \
            -map 0:a? \
            -c:v copy \
            -c:a copy \
            -start_number 10001 \
            -hls_time 4 \
            -hls_list_size 0 \
            -hls_segment_type fmp4 \
            -hls_fmp4_init_filename "${{ github.event.inputs.slug }}-index.png" \
            -hls_segment_filename "output/${{ github.event.inputs.slug }}-index%d.png" \
            -f hls "output/${{ github.event.inputs.slug }}.m3u8"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.accountId }}
          projectName: ${{ github.event.inputs.projectName }}
          directory: ./output
          branch: ${{ github.event.inputs.slug }}

      - name: Callback success
        if: success()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=ok" \
            --data-urlencode "key=${{ github.event.inputs.projectName }}" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"

      - name: Callback error
        if: failure()
        run: |
          curl -G "https://cp.ssplay.net/cf.php" \
            --data-urlencode "type=error" \
            --data-urlencode "slug=${{ github.event.inputs.slug }}"
